<!DOCTYPE html>
<html lang="ru" dir="ltr">
  <head>
    <meta charset="utf-8">
    <title>Node js</title>
  </head>
  <body>
    <h1> –ü—Ä–∏–≤–µ—Ç –ú–∏—Ä </h1>
  </body>
</html>

const express = require('express');
const app = express();
const url = require('url');

//telegram-bot-api
const TelegramBot = require('node-telegram-bot-api');
const request = require('request');
const token = '725276890:AAFZsqsDgLvLfhgY8t-9lhjhCN-ZwAazqUM';

//PROXY
const bot = new TelegramBot(token, {
  polling: true,
  request: {
    proxy: "http://194.26.180.142:3128"
  }
});

var questions = [{
  title: '–ö—Ç–æ –Ω–∞–∂–∞–ª –Ω–∞ —ç—Ç—É –∫–Ω–æ–ø–∫—É?',
  buttons: [
    [{
      text: 'click me',
      callback_data: '1'
    }]
  ]
}];


function newQuestion() {
  var arr = questions[0];
  var text = arr.title;
  var options = {
    reply_markup: JSON.stringify({
      inline_keyboard: arr.buttons
    })
  };
  bot.sendMessage(-276583637, text, options);
}

newQuestion();

bot.on('callback_query', msg => {
    bot.editMessageText(msg.message.text+' '+ msg.from.first_name + ' ' + msg.from.last_name,  {
                chat_id: -276583637,
                message_id: msg.message.message_id
            })

})

let preRating = [ ];

bot.onText(/.+/, function(msg, match) {
    if(msg.reply_to_message && msg.text === "+" || msg.text.toLowerCase() === "—Å–ø–∞—Å–∏–±–æ")
    {
      console.log(msg.reply_to_message)
      preRating.push( msg.reply_to_message.from.first_name)
    }
});

function countPlus(preRating) {
    let finalRating = [];
    for (let i=0; i<preRating.length; i++) {
        if (finalRating[preRating[i]] === undefined) {
            finalRating[preRating[i]] = 1;
        } else {
            finalRating[preRating[i]]++;
        }
    }
    return finalRating
}


// bot.onText(/\/rating/, function(msg, match) {
//   let result =  preRating
//   let like = 0
//     for (let i=0; i<result.length; i++) {
//       like = result[i]
//     }
// });


// bot.onText(/\/rating/, function onLoveText(msg) {
//     console.log(1)
//     let result = countPlus(preRating).sort(function(a, b) {
//         return b - a;
//     });
//     console.log(1, result)
//     for (let i=0; i<result.length; i++) {
//         bot.sendMessage(msg.chat.id, i +' –º–µ—Å—Ç–æ', result[i]);
//     }
// })

bot.onText(/\/rating/, function onLoveText(msg) {
    let result = [];
    for (let name in countPlus(preRating)) {
        result.push([name, countPlus(preRating)[name]]);
    }
    result.sort(function(a, b) {
        return a[1] - b[1];
    });
    console.log(result)
    for (let i=0; i<result.length; i++) {
        bot.sendMessage(msg.chat.id, i+1 +' –º–µ—Å—Ç–æ - '+ result[i] + " üíõ ");
    }
})



////////////////////////////////////////
bot.onText(/.+/, function(msg, match) {
    pushInArray(msg)
    console.log(msg)
})
    // .then(result => {
    // console.log(result)})

let preRating = [ ];

function pushInArray(msg) {
    console.log("–ö–æ–º–∞–Ω–¥–∞ —Å—Ä–∞–±–æ—Ç–∞–ª–∞ –Ω–∞ ", msg.text)
    if (
        msg.reply_to_message.from.is_bot === false &&
        msg.text === "+" || msg.text.toLowerCase() === "—Å–ø–∞—Å–∏–±–æ"
    ) {
        console.log("–î–æ–±–∞–≤–ª–µ–Ω", msg.reply_to_message.from.first_name)
        preRating.push(msg.reply_to_message.from.first_name)
    }

}


function countPlus(preRating) {
    let finalRating = {};
    for (let i=0; i<preRating.length; i++) {
        if (finalRating[preRating[i]] === undefined) {
            finalRating[preRating[i]] = 1;
        } else {
            finalRating[preRating[i]]++;
        }
    }
    console.log("–°—É–º–º–∞",finalRating)
    return finalRating
}


bot.onText(/\/start/, function onLoveText(msg) {
    console.log("–ö–æ–º–∞–Ω–¥–∞ —Å—Ç–∞—Ä—Ç —Å—Ä–∞–±–æ—Ç–∞–ª–∞")
    let ogject = countPlus(preRating)
    console.log(ogject)
    let result = [];
    for (let name in ogject) {
        result.push([name, ogject[name]]);
    }
    result.sort(function(a, b) {
        return b[1] - a[1];
    });
    // let result = countPlus(preRating).sort(function(a, b) {
    //     return b - a;
    // });
    console.log("–ö–æ–Ω–µ—á–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç", result)
    for (let i=0; i<result.length; i++) {
        bot.sendMessage(msg.chat.id, i+1 +' –º–µ—Å—Ç–æ '+ result[i][0] + " - " + result[i][1] +  " –≥–æ–ª–æ—Å–∞");
        // i+1 +' –º–µ—Å—Ç–æ - '+ result[i] + " –≥–æ–ª–æ—Å–∞"
    }
})

bot.onText(/http.+/, async (msg) => {
  let link = msg.text;
  console.log(link)
  try { await sendDocument(id: msg.chat.id, url: link)}
  catch (err) {bot.sendMessage(msg.chat.id,err)}

})

historyArr.push({
   first_name: msg.from.first_name ,
   last_name: msg.from.last_name,
   date: msg.date,
   reply_first_name: msg.reply_to_message.from.first_name,
   reply_message :msg.reply_to_message.chat.text,
   msg_text: msg.text
})
